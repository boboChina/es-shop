$.zTree={index:1,treeTemplate:'<ul id="treeSelect{id}" class="ztree"></ul>',selectTreeTemplate:'<div id="treeContent{id}" class="treeContent" style="display:none; position: absolute;">{tree}</div>',autocompleteTemplate:'<div class="control-group tree-search" style="margin-top:5px;"><label for="searchName{id}">名称</label><div class="controls"><input type="text" id="searchName{id}" class="input-medium" placeholder="模糊匹配 回车键查询"/></div></div>',initMovableTree:function(g){g.renameUrl=g.renameUrl||(g.urlPrefix+"/ajax/{id}/rename?newName={newName}");
g.removeUrl=g.removeUrl||(g.urlPrefix+"/ajax/{id}/delete");
g.addUrl=g.addUrl||(g.urlPrefix+"/ajax/{id}/appendChild");
g.moveUrl=g.moveUrl||(g.urlPrefix+"/ajax/{sourceId}/{targetId}/{moveType}/move");
g.asyncLoadAll=g.asyncLoadAll||false;
g.loadUrl=g.loadUrl||(g.urlPrefix+"/ajax/load?async="+g.async+"&asyncLoadAll="+g.asyncLoadAll+(g.excludeId?"&excludeId="+g.excludeId:"")+(g.onlyDisplayShow?"&search.show_eq=true":""));
if(g.editable!=false){g.editable=true
}if(!g.permission){g.permission={}
}g.permission=$.extend({create:false,update:false,remove:false,move:false},g.permission);
var p={noSwitchIcon:true,async:{enable:g.async,url:g.loadUrl,autoParam:["id"],dataFilter:$.zTree.filter},view:{addHoverDom:g.permission.create?j:null,removeHoverDom:g.permission.create?b:null,selectedMulti:false},edit:{enable:true,editNameSelectAll:true,showRemoveBtn:g.permission.remove?function(r,q){return !q.root
}:null,showRenameBtn:g.permission.update,removeTitle:"移除",renameTitle:"重命名",drag:{isMove:g.permission.move,isCopy:false,prev:h,inner:h,next:h}},data:{simpleData:{enable:true}},callback:{beforeRemove:function(r,q){return confirm("确认删除吗？")
},beforeRename:f,onRemove:i,onRename:e,onDrop:a}};
if(!g.editable){p.edit={};
p.view.addHoverDom=null;
p.view.removeHoverDom=null
}if(g,p){p=$.extend(true,g.setting,p);
g.setting=p
}function h(t,r,u){if(!u||!u.getParentNode()){return false
}for(var s=0,q=r.length;
s<q;s++){if(r[s].root===true){return false
}}return true
}function j(u,t){var q=$("#"+t.tId+"_span");
if(t.editNameFlag||$("#addBtn_"+t.id).length>0){return
}var r="<span class='button add' id='addBtn_"+t.id+"' title='添加子节点' onfocus='this.blur();'></span>";
q.after(r);
var s=$("#addBtn_"+t.id);
if(s){s.bind("click",function(v){m(v,u,t);
return false
})}}function b(r,q){$("#addBtn_"+q.id).unbind().remove()
}function f(u,t,q){var s=t.name;
if(q.length==0){$.app.alert({message:"节点名称不能为空。"});
return false
}if(!confirm("确认重命名吗？")){var r=$.fn.zTree.getZTreeObj(u);
r.cancelEditName(t.name);
return false
}return true
}function e(t,s,r){var q=g.renameUrl.replace("{id}",r.id).replace("{newName}",r.name);
$.app.waiting("操作中...",true);
$.getJSON(q,function(u){$.app.waitingOver()
})}function i(t,s,r){var q=g.removeUrl.replace("{id}",r.id);
$.app.waiting("操作中...",true);
$.getJSON(q,function(u){$.app.waitingOver()
})}function m(t,s,r){var q=g.addUrl.replace("{id}",r.id);
$.app.waiting("操作中...",true);
$.getJSON(q,function(u){var v={id:u.id,pId:u.pId,name:u.name,iconSkin:u.iconSkin,open:true,click:u.click,root:u.root,isParent:u.isParent};
var u=n.addNodes(r,v)[0];
$("#"+u.tId+"_a").click();
$.app.waitingOver()
})}function a(r,t,s,u,y,v){if(!u||s.length==0){return
}var w=s[0].id;
var x=u.id;
var y=y;var q=g.moveUrl.replace("{sourceId}",w).replace("{targetId}",x).replace("{moveType}",y);
$.app.waiting("操作中...",true);
$.getJSON(q,function(z){$.app.waitingOver()
})}var o=g.autocomplete&&g.autocomplete.enable;
var d=this.index++;
var k=(o?this.autocompleteTemplate:"")+this.treeTemplate;
var c=null;
if(g.containerId){c=$("#"+g.containerId)
}else{c=$("body")
}c.append(k.replace(/{id}/g,d));
var l="treeSelect"+d;
var n=$.fn.zTree.init($("#"+l),p,g.zNodes);
if(o){if(!g.autocomplete.minLength){g.autocomplete.minLength=0
}g.autocomplete.enterSearch=true;
g.autocomplete.input=$("#searchName"+d);
g.autocomplete.async=g.autocomplete.async||g.async;
g.autocomplete.select=g.autocomplete.select||function(s,t){var q=t.item.value;
var r=g.loadUrl+"&searchName="+q;
n.destroy();
$.getJSON(r,function(u){if(u.length>0){n=$.fn.zTree.init($("#"+l),p,u)
}})};g.autocomplete.source=g.autocomplete.source||g.urlPrefix+"/ajax/autocomplete?1=1"+(g.excludeId?"&excludeId="+g.excludeId:"")+(g.onlyDisplayShow?"&search.show_eq=true":"");
g.treeId=l;
$.app.initAutocomplete(g.autocomplete)
}return l},initSelectTree:function(q){q.asyncLoadAll=q.asyncLoadAll||false;
q.loadUrl=q.loadUrl||(q.urlPrefix+"/ajax/load?async="+q.async+"&asyncLoadAll="+q.asyncLoadAll+(q.excludeId?"&excludeId="+q.excludeId:"")+(q.onlyDisplayShow?"&search.show_eq=true":"")+"&onlyCheckLeaf="+((q.setting&&q.setting.check&&q.setting.check.onlyCheckLeaf)?true:false));
var i=q.autocomplete&&q.autocomplete.enable;
var k=this.index++;
var p=(i?this.autocompleteTemplate:"")+this.treeTemplate;
var f=this.selectTreeTemplate.replace("{tree}",p);
$("body").append(f.replace(/{id}/g,k));
var g=$("#"+q.select.id);
var e=$("#"+q.select.name);
var m="treeContent"+k;
var n=$("#"+m);
var o="treeSelect"+k;
var l={noSwitchIcon:true,async:{enable:q.async,url:q.loadUrl,autoParam:["id"],dataFilter:$.zTree.filter},view:{dblClickExpand:false},data:{simpleData:{enable:true}},callback:{onClick:c,onCheck:c}};
if(q.setting){l=$.extend(true,q.setting,l)
}function s(t){var u=t.name;
while((t=t.getParentNode())){if(t.root&&!q.select.includeRoot){break
}u=t.name+" > "+u
}return u}function c(B,A,D){if(!l.check||!l.check.enable){var v=b.getSelectedNodes();
var u=v[v.length-1];
e.prop("value",s(u));
g.prop("value",u.id);
r()}else{var v=b.getCheckedNodes(true);
var C="";var t="";
var w=q.setting.check&&q.setting.check.onlySelectLeaf;
for(var z=0,y=v.length;
z<y;z++){var x=v[z];
if(w&&x.isParent){continue
}C+=s(x)+(z!=y-1?",":"");
t+=x.id+(z!=y-1?",":"")
}e.prop("value",C);
e.change();
g.prop("value",t);
g.change()}}function j(){var t=e.offset();
n.css({left:t.left+"px",top:t.top+e.outerHeight()+"px"}).slideDown("fast");
$("body").bind("mousedown",d)
}function r(){n.fadeOut("fast");
$("body").unbind("mousedown",d)
}function d(t){var u=false;
q.select.btn.each(function(){u=u||t.target==this||t.target.parentNode==this||(t.target.parentNode?t.target.parentNode.parentNode:null)==this
});if(!(u||$(t.target).closest(".ui-autocomplete").length>0||t.target.id==m||$(t.target).closest("#"+m).length>0)){r()
}}q.select.btn.click(function(){if(n.is(":visible")){r()
}else{j()}});
var b=null;
var h=function(){$.zTree.prepareZNodes(q.zNodes,q);
b=$.fn.zTree.init($("#"+o),l,q.zNodes);
if(i){if(!q.autocomplete.minLength){q.autocomplete.minLength=0
}q.autocomplete.enterSearch=true;
q.autocomplete.input=$("#searchName"+k);
q.autocomplete.async=q.autocomplete.async||q.async;
q.autocomplete.select=q.autocomplete.select||function(v,w){var t=w.item.value;
var u=q.loadUrl+"&searchName="+t;
b.destroy();
$.getJSON(u,function(y){var x=y.length;
if(x>0){$.zTree.prepareZNodes(y,q);
b=$.fn.zTree.init($("#"+o),l,y)
}})};q.autocomplete.source=q.autocomplete.source||q.urlPrefix+"/ajax/autocomplete?1=1"+(q.excludeId?"&excludeId="+q.excludeId:"")+(q.onlyDisplayShow?"&search.show_eq=true":"");
q.treeId=o;
$.app.initAutocomplete(q.autocomplete)
}};var a=false;
if(q.lazy){q.select.btn.click(function(){if(!a){h();
a=true}})}else{h()
}return o},prepareZNodes:function(f,b){if(!f){return
}var e=f.length;
if(!e){return
}var a=b.setting&&b.setting.check&&b.setting.check.onlySelectLeaf;
for(var c=0;
c<e;c++){var d=f[c];
if(a&&d.isParent){d.nocheck=true
}else{d.nocheck=false
}}},initMaintainBtn:function(a,d,c){var f=a+"/{id}/update",e=a+"/batch/delete",b=a+"/{id}/move?async="+c;
$("#moveTree").off("click").on("click",function(){var g=$("#"+d);
var h=$.table.getFirstSelectedCheckbox(g);
if(!h.length){return
}if(h.filter("[root='true']").length){$.app.alert({message:"根节点不能移动！"});
return}window.location.href=b.replace("{id}",h.val())+"&BackURL="+$.table.encodeTableURL(g);
return false
});$("#updateTree").off("click").on("click",function(){var g=$("#"+d);
var h=$.table.getFirstSelectedCheckbox(g);
if(!h.length){return
}window.location.href=f.replace("{id}",h.val())+"?BackURL="+$.table.encodeTableURL(g)
});$("#deleteTree").off("click").on("click",function(){var g=$("#"+d);
var h=$.table.getAllSelectedCheckbox(g);
if(!h.length){return
}if(h.filter("[root='true']").length){$.app.alert({message:"您删除的数据中包含根节点，根节点不能删除！"});
return}$.app.confirm({width:500,message:"确认删除吗？",ok:function(){window.location.href=e+"?"+h.serialize()+"&BackURL="+$.table.encodeTableURL(g)
}});return false
})},initMoveBtn:function(){$("#moveAsPrev").click(function(){$("#moveType").val("prev")
});$("#moveAsNext").click(function(){$("#moveType").val("next")
});$("#moveAsInner").click(function(){$("#moveType").val("inner")
})},split:function(a){return a.split(/,\s*/)
},extractLast:function(a){return this.split(a).pop()
},filter:function(b,a,c){if(!c){return null
}return c}};